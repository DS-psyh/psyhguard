<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>PsyhGuard — Отслеживание внимания</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3b82f6">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root{
      --bg:#f7f8fb; --card:#fff; --txt:#111827; --muted:#6b7280; --line:#e8ebf2;
      --accent:#3b82f6; --accent-strong:#2563eb; --pos:#10b981;
      --warn:#fee2e2; --warnb:#ef4444;
      --c1:#bcd4ff; --c2:#bfead9; --c3:#ffe1b5; --c4:#e8c9ff; --c5:#ffd0d4; --c6:#c8f1ff; --c7:#d6f5c8; --c8:#cdd8ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1100px;margin:20px auto 120px;padding:0 14px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{margin:0;font-size:22px}
    .btn{cursor:pointer;padding:10px 14px;border-radius:10px;background:#fff;color:var(--txt);border:1px solid var(--line);font-size:16px}
    .btn.primary{background:var(--accent);color:#fff;border:none;font-weight:600}
    .btn.primary:hover{background:var(--accent-strong)}
    .btn.xs{padding:6px 10px;font-size:13px;border-radius:8px}
    .btn.danger{background:var(--warn);border-color:#fecaca}
    .btn.danger.on{background:#fecaca;border-color:var(--warnb);color:#7f1d1d;font-weight:700}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 8px rgba(17,24,39,.04);padding:14px}
    .hint{margin-top:6px}
    .month{margin-top:14px}
    .month-head{display:flex;align-items:center;gap:10px;cursor:pointer}
    .month-title{font-weight:700}
    .columns{display:flex;gap:12px;align-items:flex-end;overflow-x:auto;padding:8px 0}
    .col{min-width:140px;display:flex;flex-direction:column;align-items:center;gap:8px}
    .bar{
      width:100%; height:260px; border:1px solid var(--line); border-radius:12px; background:#fff;
      padding:6px; display:flex; flex-direction:column-reverse; gap:4px; overflow:hidden;
    }
    .cell{height:10px;border-radius:6px;opacity:.95;background:var(--pos)}
    .meta{display:flex;flex-direction:column;align-items:center;margin-top:2px}
    .col-name{font-weight:700;text-align:center;border-bottom:3px solid transparent}
    .count{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:6px}
    .controls .btn{min-width:38px}
    .addCol{display:flex;gap:8px;margin:8px 0}
    .input{width:260px;max-width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:16px}
    .divider{height:1px;background:var(--line);margin:10px 0}

    /* bottom actions */
    .bottom-bar{
      position:fixed;left:0;right:0;bottom:0;background:#f9fafc;border-top:1px solid var(--line);
      padding:10px 14px;display:flex;gap:12px;justify-content:space-between
    }
    .wide{flex:1}

    /* delete mode styles */
    body.del-mode .controls .btn.plus{background:#ffe4e6;border-color:#fecdd3}
    body.del-mode .controls .btn.plus:hover{background:#fecaca}

    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px}
    .modal .box{max-width:900px;width:100%;background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px}
    .table{width:100%;border-collapse:collapse;margin-top:8px}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:left}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 class="title">PsyhGuard — Отслеживание внимания</h1>
    <div class="row">
      <a class="btn" href="cabinet.html">Кабинет</a>
    </div>
  </div>

  <div class="card">
    <div class="row" style="align-items:center;justify-content:space-between;">
      <div><span class="muted">Текущий раздел:</span> <b>Месяц</b></div>
      <div class="addCol">
        <input id="newColName" class="input" placeholder="Новый столбик (например, «Спорт»)" />
        <button id="addColBtn" class="btn">Добавить столбик</button>
        <button id="delModeBtn" class="btn danger">Удалить столбик</button>
      </div>
    </div>
    <div id="delHint" class="muted hint" style="display:none;">Режим удаления включён: нажмите «+» на нужном столбике, чтобы удалить его.</div>
    <div id="months"></div>
  </div>
</div>

<!-- Bottom actions -->
<div class="bottom-bar">
  <button id="newMonthBtn" class="btn wide">Новый месяц</button>
  <button id="statsBtn" class="btn primary wide">Статистика за всё время</button>
</div>

<!-- Stats modal -->
<div id="statsModal" class="modal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <h3 style="margin:0;">Статистика за всё время</h3>
      <button id="closeStats" class="btn xs">Закрыть</button>
    </div>
    <div class="muted">Сумма существующих ячеек по всем месяцам.</div>
    <table class="table" id="statsTable">
      <thead>
        <tr><th>Столбик</th><th>Итого</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  /* ---------- utils & storage ---------- */
  const SKEY='psyhguard-attn-v2'; // новый ключ, чтобы не конфликтовать со старым форматом
  const COLORS=['var(--c1)','var(--c2)','var(--c3)','var(--c4)','var(--c5)','var(--c6)','var(--c7)','var(--c8)'];
  const colorAt=i=>COLORS[i%COLORS.length];
  const uid=()=>Math.random().toString(36).slice(2,10);

  const MONTHS_RU=['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
  const monthTitle=d=>`${MONTHS_RU[d.getMonth()]} ${d.getFullYear()}`;

  function load(){ try{const x=localStorage.getItem(SKEY);return x?JSON.parse(x):null}catch{return null}}
  function save(v){ localStorage.setItem(SKEY, JSON.stringify(v)); }

  /* ---------- state ---------- */
  let app = load();
  if(!app){
    const now=new Date();
    app = {
      startedAt: Date.now(),
      months: [{
        id: uid(),
        title: monthTitle(now),
        createdAt: Date.now(),
        collapsed: false,
        columns: [] // {id,name,colorIdx,cells:[1,1,1,...]}
      }],
      deleteMode: false
    };
    save(app);
  }
  let deleteMode = !!app.deleteMode;

  /* ---------- DOM refs ---------- */
  const elMonths = document.getElementById('months');
  const elNewCol = document.getElementById('newColName');
  const addColBtn = document.getElementById('addColBtn');
  const delModeBtn = document.getElementById('delModeBtn');
  const delHint = document.getElementById('delHint');

  const newMonthBtn = document.getElementById('newMonthBtn');
  const statsBtn = document.getElementById('statsBtn');
  const statsModal = document.getElementById('statsModal');
  const closeStats = document.getElementById('closeStats');
  const statsBody = document.querySelector('#statsTable tbody');

  function setDeleteMode(on){
    deleteMode = on;
    app.deleteMode = on;
    document.body.classList.toggle('del-mode', on);
    delHint.style.display = on ? 'block' : 'none';
    delModeBtn.classList.toggle('on', on);
    save(app);
  }

  /* ---------- rendering ---------- */
  function render(){
    elMonths.innerHTML='';
    app.months.forEach((m,mi)=>{
      const mWrap=document.createElement('div'); mWrap.className='month';

      // header (accordion)
      const head=document.createElement('div'); head.className='month-head';
      const caret=document.createElement('span'); caret.className='btn xs'; caret.textContent = m.collapsed ? 'Раскрыть' : 'Свернуть';
      const title=document.createElement('div'); title.className='month-title'; title.textContent=m.title;
      head.appendChild(title); head.appendChild(caret);
      head.onclick=()=>{ m.collapsed=!m.collapsed; save(app); render(); };

      mWrap.appendChild(head);

      if(!m.collapsed){
        const cols=document.createElement('div'); cols.className='columns';

        if(m.columns.length===0){
          const empty=document.createElement('div');
          empty.className='muted'; empty.style.padding='12px';
          empty.textContent='Нет столбиков. Добавьте первый — выше справа.';
          cols.appendChild(empty);
        } else {
          m.columns.forEach((c,ci)=>{
            const card=document.createElement('div'); card.className='col';

            // график
            const bar=document.createElement('div'); bar.className='bar';
            (c.cells||[]).forEach(()=>{ const cell=document.createElement('div'); cell.className='cell'; bar.appendChild(cell); });

            // подписи — теперь снизу
            const meta=document.createElement('div'); meta.className='meta';
            const name=document.createElement('div'); name.className='col-name'; name.textContent=c.name;
            name.style.borderBottomColor = colorAt(c.colorIdx);
            name.title='Клик — переименовать';
            name.onclick=()=>{
              const nv=prompt('Название столбика:', c.name);
              if(nv && nv.trim()){ c.name=nv.trim(); save(app); render(); }
            };
            const cnt=document.createElement('div'); cnt.className='count';
            cnt.textContent=`записей: ${c.cells.length}`;
            meta.appendChild(name); meta.appendChild(cnt);

            // кнопки
            const ctrls=document.createElement('div'); ctrls.className='controls';
            const bMinus=document.createElement('button'); bMinus.className='btn'; bMinus.textContent='−';
            bMinus.title='Убрать одну ячейку';
            bMinus.onclick=()=>{
              if(c.cells.length>0){ c.cells.pop(); save(app); render(); }
            };

            const bPlus=document.createElement('button'); bPlus.className='btn plus'; bPlus.textContent='+';
            bPlus.title='Добавить ячейку (или удалить столбик в режиме удаления)';
            bPlus.onclick=()=>{
              if(deleteMode){
                if(confirm(`Удалить столбик «${c.name}» из месяца «${m.title}»?`)){
                  m.columns = m.columns.filter(x=>x.id!==c.id);
                  save(app); render();
                }
              }else{
                c.cells.push(1); save(app); render();
              }
            };

            ctrls.appendChild(bMinus);
            ctrls.appendChild(bPlus);

            card.appendChild(bar);
            card.appendChild(meta);
            card.appendChild(ctrls);
            cols.appendChild(card);
          });
        }

        mWrap.appendChild(cols);
        if(mi < app.months.length-1){
          const hr=document.createElement('div'); hr.className='divider';
          mWrap.appendChild(hr);
        }
      }

      elMonths.appendChild(mWrap);
    });

    setDeleteMode(deleteMode); // обновить визуал кнопки/хинта
  }

  /* ---------- actions ---------- */
  addColBtn.onclick=()=>{
    const v=(elNewCol.value||'').trim(); if(!v) return;
    const cur=app.months.find(m=>!m.collapsed) || app.months[app.months.length-1];
    const colorIdx = cur.columns.length % 8;
    cur.columns.push({id:uid(),name:v,colorIdx,cells:[]});
    elNewCol.value='';
    save(app); render();
  };

  delModeBtn.onclick=()=> setDeleteMode(!deleteMode);

  newMonthBtn.onclick=()=>{
    const last = app.months[app.months.length-1];
    last.collapsed = true;

    const now=new Date();
    const next = {
      id: uid(),
      title: monthTitle(now),
      createdAt: Date.now(),
      collapsed: false,
      columns: (last.columns||[]).map((c,i)=>({id:uid(),name:c.name,colorIdx:i,cells:[]}))
    };
    app.months.push(next);
    save(app); render();
  };

  function getAllTimeStats(){
    const map = {};
    app.months.forEach(m=>{
      (m.columns||[]).forEach(c=>{
        if(!map[c.name]) map[c.name]=0;
        map[c.name]+= (c.cells?.length||0);
      });
    });
    return map;
  }

  function renderStats(){
    const stats=getAllTimeStats();
    statsBody.innerHTML='';
    Object.keys(stats).sort().forEach(name=>{
      const tr=document.createElement('tr');
      const td1=document.createElement('td'); td1.textContent=name;
      const td2=document.createElement('td'); td2.textContent=stats[name];
      tr.appendChild(td1); tr.appendChild(td2);
      statsBody.appendChild(tr);
    });
  }

  statsBtn.onclick=()=>{ renderStats(); statsModal.style.display='flex'; };
  closeStats.onclick=()=>{ statsModal.style.display='none'; };
  statsModal.addEventListener('click',e=>{ if(e.target===statsModal) statsModal.style.display='none'; });

  /* ---------- init ---------- */
  render();

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    });
  }
</script>
</body>
</html>
